## 概述
如果你要上行自定义的视频（如外部设备、屏幕捕获或合成的视频），可以通过实现自定义视频采集器（VideoCapturer 接口），并设置给 SDK。以下是完整实现步骤：
1. 创建自定义的 VideoCapturer。
2. 通过 TcrSessionConfig.Builder#enableCustomVideoCapture() 方法注入自定义的 VideoCapturer 实例。
3. 通过 TcrSession#setEnableLocalVideo(true) 开启视频上行。
4. 【可选】通过 TcrSession#setLocalVideoProfile() 控制上行视频的参数（依赖 VideoCapturer#changeCaptureFormat() 的实现）。

> **注：** 此功能需依赖 tcrsdk-full:3.30.x 版本

## 创建自定义 VideoCapturer
### VideoCapturer 接口方法的作用与实现指导

从 TcrSdk 的设计逻辑来看，`VideoCapturer` 接口定义了视频捕获器的生命周期和行为规范。其核心目的是**解耦视频源（如相机、屏幕、文件）与 TcrSdk 处理流水线**，使开发者能灵活实现自定义视频源。接口方法的设计遵循以下原则：
- **生命周期管理**：明确初始化、启动、停止、销毁阶段。
- **异步与线程安全**：方法可能在不同线程调用，需确保线程安全（如使用 `volatile` 标志或 `Handler`）。
- **资源优化**：通过 `dispose` 防止资源泄漏，通过 `isScreencast` 优化编码策略。
- **格式协商**：允许动态调整捕获参数以适应网络或设备条件（但非强制支持）。

以下基于 TcrSdk 设计逻辑和实现示例（[TextureVideoCapturer](../Demo/TcrDemo/app/src/tcrdemo/java/com/tencent/tcrdemo/gameplay/TextureVideoCapturer.java) 和 [YuvVideoCapturer](../Demo/TcrDemo/app/src/tcrdemo/java/com/tencent/tcrdemo/gameplay/YuvVideoCapturer.java)），解释每个方法的作用，并提供开发者实现指导。

---

#### 1. **`initialize(SurfaceTextureHelper surfaceTextureHelper, Context applicationContext, CapturerObserver capturerObserver)`**
   - **作用**：
     - **初始化捕获器环境**：在首次调用 `startCapture` 前执行一次，用于准备资源（如打开文件、初始化解码器）。
     - **绑定关键组件**：
       - `SurfaceTextureHelper`：处理纹理帧的渲染和线程管理（TcrSdk 内部提供），开发者需使用它生成或接收纹理类型的视频帧。
       - `Context`：访问 Android 系统资源（如文件路径、硬件）。
       - `CapturerObserver`：回调接口，用于将捕获的帧传递给 TcrSdk 流水线（如编码、传输）。
     - **设计逻辑**：TcrSdk 通过此方法将渲染和控制权分离。`SurfaceTextureHelper` 由 TcrSdk 管理生命周期，开发者仅需在其上渲染或读取纹理帧。

   - **实现指导**：
     - **必需操作**：
       - 保存参数引用（如使用纹理帧，`this.surfaceTextureHelper = surfaceTextureHelper`），用于后续帧生成。
       - 初始化资源（如 `MediaPlayer` 或文件读取器），但**不启动捕获**。
       - 检查无效状态（如 `disposed`），避免操作已释放的资源（参考 `TextureVideoCapturer.checkNotDisposed()`）。
     - **最佳实践**：
       - 若使用纹理帧（如 `TextureVideoCapturer`），通过 `surfaceTextureHelper.getSurfaceTexture()` 设置渲染表面。
       - 若使用 I420 帧（如 `YuvVideoCapturer`），忽略 `SurfaceTextureHelper`，直接操作 `JavaI420Buffer`。
       - 捕获错误：抛出异常或记录日志（如文件读取失败时）。
     - **示例参考**：
       - `TextureVideoCapturer`：初始化 `MediaPlayer` 并设置数据源。
       - `YuvVideoCapturer`：保存 `CapturerObserver`，不直接使用 `SurfaceTextureHelper`。

---

#### 2. **`startCapture(int width, int height, int framerate)`**
   - **作用**：
     - **启动视频捕获**：以指定格式（宽、高、帧率）开始生成帧。
     - **格式协商**：参数是目标格式，实际输出可近似（TcrSdk 能处理缩放/插值）。
     - **设计逻辑**：TcrSdk 在需要视频流时调用此方法（如加入房间）。捕获器应以稳定速率生成帧，并通过 `CapturerObserver.onFrameCaptured` 传递帧。

   - **实现指导**：
     - **必需操作**：
       - 启动帧生成逻辑（如开始媒体播放、启动定时器）。
       - 调用 `capturerObserver.onCapturerStarted(true)` 通知 TcrSdk 捕获开始。
       - 若使用纹理，启动 `SurfaceTextureHelper` 监听（如 `surfaceTextureHelper.startListening(this)`）。
     - **线程安全**：
       - 使用 `volatile` 标志（如 `isCapturing`）避免重复启动。
       - 若已在运行，直接返回（参考 `TextureVideoCapturer` 中的 `if (isCapturing) return`）。
     - **帧率控制**：
       - 文件捕获：使用定时器（如 `YuvVideoCapturer` 的 `Timer`）模拟帧率。
       - 实时源：依赖硬件帧率。
     - **示例参考**：
       - `TextureVideoCapturer`：启动 `MediaPlayer` 并设置 `OnPreparedListener`。
       - `YuvVideoCapturer`：创建定时任务周期性调用 `tick()` 生成帧。

---

#### 3. **`stopCapture() throws InterruptedException`**
   - **作用**：
     - **停止捕获并阻塞直到完成**：确保无残留帧或资源占用。
     - **设计逻辑**：TcrSdk 在流结束或资源释放时调用此方法。阻塞设计防止异步停止导致帧丢失或状态不一致。

   - **实现指导**：
     - **必需操作**：
       - 停止帧生成（如暂停媒体播放器、取消定时器）。
       - 调用 `capturerObserver.onCapturerStopped()` 通知 TcrSdk。
       - **阻塞实现**：使用同步机制（如 `ThreadUtils.invokeAtFrontUninterruptibly` 在 `Handler` 线程操作）。
     - **资源清理**：
       - 释放临时资源（如关闭文件句柄），但保留核心资源供 `dispose` 处理。
       - 设置状态标志（如 `isCapturing = false`）。
     - **错误处理**：抛出 `InterruptedException` 响应线程中断（如强制停止时）。
     - **示例参考**：
       - `TextureVideoCapturer`：在 `Handler` 线程中停止 `MediaPlayer` 并更新状态。
       - `YuvVideoCapturer`：取消定时任务并设置 `isCapturing=false`.

---

#### 4. **`changeCaptureFormat(int width, int height, int framerate)`**
   - **作用**：
     - **动态调整捕获格式**：响应分辨率或帧率变更请求（如网络带宽变化）。
     - **设计逻辑**：TcrSdk 调用此方法优化资源，但非所有捕获器必须支持（如文件源可能固定格式）。

   - **实现指导**：
     - **支持场景**：
       - 若可实现（如相机源），重新配置参数（如调整 `MediaPlayer` 分辨率）。
       - 重启捕获：必要时先 `stopCapture()` 再 `startCapture()`。
     - **不支持场景**：
       - 记录警告（如 `Log.w(TAG, "not supported")`），TcrSdk 会继续使用原格式。
       - 无需抛出异常（参考 `YuvVideoCapturer` 的实现）。
     - **最佳实践**：避免资源重分配（如重新打开文件），优先内部调整。
     - **示例参考**：`TextureVideoCapturer` 和 `YuvVideoCapturer` 均不支持，仅打印日志。

---

#### 5. **`dispose()`**
   - **作用**：
     - **释放所有资源**：捕获器销毁前的最终清理。
     - **设计逻辑**：TcrSdk 在不再需要捕获器时调用（如退出房间），防止内存/资源泄漏。

   - **实现指导**：
     - **必需操作**：
       - 若捕获中，先调用 `stopCapture()`（如 `if (isCapturing) stopCapture()`）。
       - 释放核心资源（如 `MediaPlayer.release()` 或关闭文件通道）。
       - 设置 `disposed` 标志（如 `isDisposed = true`），并在其他方法中校验（参考 `checkNotDisposed()`）。
     - **错误处理**：捕获异常并记录（如文件关闭失败），但确保资源最终释放。
     - **线程安全**：使用 `synchronized` 或原子操作避免竞争。
     - **示例参考**：
       - `TextureVideoCapturer`：释放 `MediaPlayer` 并更新状态。
       - `YuvVideoCapturer`：关闭视频文件并取消定时器。

---

#### 6. **`isScreencast()`**
   - **作用**：
     - **标识捕获器类型**：返回 `true` 表示屏幕捕获，`false` 表示其他（如相机、文件）。
     - **设计逻辑**：TcrSdk 根据此标识优化编码（如屏幕内容用更高效编码器）或 UI 处理（如避免镜像）。

   - **实现指导**：
     - **必需操作**：
       - 屏幕捕获源返回 `true`（需系统权限）。
       - 非屏幕源（如文件、相机）返回 `false`。
     - **静态属性**：通常为固定值，无需运行时计算。
     - **示例参考**：`TextureVideoCapturer` 和 `YuvVideoCapturer` 均返回 `false`。

---

### 总结：开发者实现建议
- **生命周期顺序**：遵循 `initialize → startCapture → [changeCaptureFormat] → stopCapture → dispose`。
- **状态管理**：使用 `volatile` 标志（如 `isCapturing`, `isDisposed`）确保线程安全。
- **资源责任**：
  - `SurfaceTextureHelper` 由 TcrSdk 管理，开发者仅需使用。
  - 捕获器负责自身资源（如 `MediaPlayer`）的释放。
- **帧生成**：稳定生成帧是关键，文件源需模拟帧率（如定时器），实时源依赖硬件。
- **错误处理**：在关键方法（如 `startCapture`, `stopCapture`）添加日志和异常捕获，避免崩溃影响 TcrSdk 流水线。

通过实现此接口，开发者可将自定义视频源（如文件、游戏画面）无缝集成到 TcrSdk 中，扩展性强且符合 TcrSdk 的模块化设计哲学。

## 示例代码
参考   
[GamePlayFragment](../Demo/TcrDemo/app/src/tcrdemo/java/com/tencent/tcrdemo/gameplay/GamePlayFragment.java) 的 createSessionConfig()、createCustomVideoCapturer()、onCameraStatusChanged() 方法。
[TextureVideoCapturer](../Demo/TcrDemo/app/src/tcrdemo/java/com/tencent/tcrdemo/gameplay/TextureVideoCapturer.java)  
[YuvVideoCapturer](../Demo/TcrDemo/app/src/tcrdemo/java/com/tencent/tcrdemo/gameplay/YuvVideoCapturer.java)