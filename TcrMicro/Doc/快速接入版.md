# 1. 整体流程概述

微端有两种接入方式：快速接入版和功能增强版。快速接入版是通过下载完整游戏APK然后覆盖安装的方式实现微端包到完整包的转化。

<img
src="images/快速接入版.png" width="638px" height="370px">

# 2. 详细接入步骤

**1、部署云端包。** 将游戏APK给到腾讯云对接的工作人员，工作人员会把游戏部署到腾讯云后台服务器，返回game_id。

**2、上传完整包。** 将游戏APK上传到存储服务器，返回下载链接apk_url。

**3、构建微端包。**

第一步，下载[微端包示例工程](../Demo/微端APP示例工程/TcrMicroAppForUnity2018Empty.zip)，使用AndroidStudio打开。

第二步，修改构建脚本。
打开app模块下的build.gradle文件，修改applicationId、minSdkVersion、targetSdkVersion与您的游戏工程一致，versionCode要小于游戏包的versionCode。

```groovy
defaultConfig {
        // 应用名称和您的游戏包名一致
        applicationId "com.DefaultCompany.Unity2018Empty"
        // 与你的游戏版本保持一致
        minSdkVersion 21 // 微端SDK最低支持到16
        //noinspection ExpiredTargetSdkVersion,OldTargetApi
        targetSdkVersion 29 // 与你的游戏版本保持一致
        versionCode rootProject.ext.versionCode
        versionName rootProject.ext.versionName
        ...
}
```

修改签名文件与您的游戏工程一致。

```groovy
signingConfigs {
        release {
            keyAlias "testres"
            keyPassword "testres"
            storePassword "testres"
            storeFile file("keystore/micro.keystore")
        }
    }
```

以上两步使得微端包能被完整包覆盖安装。

第三步，修改工程配置。

打开工程assets下的microSettings.xml，修改对应参数

```xml
<?xml version="1.0" encoding="utf-8"?>
<settings>
    <!--    游戏ID。game-mkcru8bo(Unity2018)，game-h4c3xgp5(Unity2020)。-->
    <setting key="game_id" value="game-mkcru8bo" />
    <!--    是否使用热更新的方式进行升级转化。 -->
    <setting key="hot_update" value="false" />
    <!--    游戏包的地址。仅在hot_update为false的情况下才有意义。 -->
    <setting key="apk_url"
            value="https://cg-sdk-1258344699.cos.ap-nanjing.myqcloud.com/test/test.apk" />
    <!--    与云端通信的端口号-->
    <setting key="port" value="6666" />
</settings>
```

将部署之后生成的游戏ID填入到game_id中，

将apk的下载链接填入到apk_url中。

第四步，打开AndroidManifest.xml，在Application标签下新增如下内容：

```xml
<!--微端快速接入版，请新增该provider,用于安装apk -->
<provider
    android:name="androidx.core.content.FileProvider"
    android:authorities="${applicationId}.provider"
    android:exported="false"
    android:grantUriPermissions="true">
    <meta-data
        android:name="android.support.FILE_PROVIDER_PATHS"
        android:resource="@xml/micro_filepaths" />
</provider>
```

同时在res/xml目录下，新增micro_filepaths.xml文件，文件内容如下：

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <paths>
        <external-files-path
                name="download"
                path="" />
    </paths>
</resources>
```

以上步骤完成后，编译生成apk，运行验证即可。
