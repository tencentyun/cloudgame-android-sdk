# 快速接入版

快速接入版直接静默下载完整apk来完成微端包到热更包的转化。

## 接入流程

**准备工作：**

1、将游戏包给到对接群的工作人员，工作人员会把游戏部署到腾讯云后台服务器，然后返回GameID。

2、将游戏apk上传到服务器并生成下载链接。
第一步，下载[微端包示例工程](../Demo/微端APP示例工程/TcrMicroAppForUnity2018Empty.zip)，使用AndroidStudio打开。

第二步，修改构建脚本。
打开app模块下的build.gradle文件，修改applicationId、minSdkVersion、targetSdkVersion与您的游戏工程一致，versionCode要小于游戏包的versionCode。

```groovy
defaultConfig {
        // 应用名称和您的游戏包名一致
        applicationId "com.DefaultCompany.Unity2018Empty"
        // 与你的游戏版本保持一致
        minSdkVersion 21 // 微端SDK最低支持到16
        //noinspection ExpiredTargetSdkVersion,OldTargetApi
        targetSdkVersion 29 // 与你的游戏版本保持一致
        versionCode rootProject.ext.versionCode
        versionName rootProject.ext.versionName
        ...
}
```

修改签名文件与您的游戏工程一致。

```groovy
signingConfigs {
        release {
            keyAlias "testres"
            keyPassword "testres"
            storePassword "testres"
            storeFile file("keystore/micro.keystore")
        }
    }
```

以上两步保证安装之后的apk会把微端apk替换掉。

第三步，修改工程代码。

修改Config类的GAME_ID、APK_URL、PORT变量

```java
package com.unity3d.player;

import com.handley.RollBall.BuildConfig;

public class Config {

    // 游戏ID
    public static final String GAME_ID = "game-mkcru8bo";
    // Patch包下载地址
    public static final String PATCH_URL = ""; // 无热更新功能不需要配置
    // 完整Apk下载地址
    public static final String APK_URL =
            "https://recorder-10018504.cos.ap-shanghai.myqcloud.com/shaw/apk/AndroidUnity2018Empty-release.apk";
    // 与云端通信的端口号
    public static int PORT = 6666; // 无登录/支付穿透功能不需要配置
}
```

配置信息通过initConfig()方法传递给SDK。

```java
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        Log.d(TAG, "onCreate: ");
        // 初始化配置必须在父类onCreate之前
        String gameParas = "";
        // base64加密gameParas
        
        initConfig(Config.GAME_ID, Config.PATCH_URL, Config.APK_URL, gameParas/*必须base64加密*/, Config.PORT,
                BuildConfig.VERSION, ContextCompat.getDrawable(this, R.drawable.game_background));
        super.onCreate(savedInstanceState);
    }
```

将部署之后生成的游戏ID填入到GAME_ID中，

将apk的下载链接填入到APK_URL中。

同时，游戏启动时可以选择带上自定义的参数，注意参数内容如果非空必须通过base64进行编码（防止字符串中出现特殊字符导致传输出现问题），云端接收之后解码。

云端需要注册广播接收gameParas参数内容：

```java
public class MainActivity extends AppCompatActivity {

    public static class CloudGamingReceiver extends BroadcastReceiver {
        @Override
        public void onReceive(Context context, Intent intent) {
            // 获取微端参数
            Log.i("CloudGamingReceiver", "GameParas:" + intent.getStringExtra("GameParas"));
            // base64解码
        }
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // 注册监听广播
        IntentFilter intentFilter = new IntentFilter();
        intentFilter.addAction("android.intent.action.CLOUD_GAMING_STARTED");
        registerReceiver(new CloudGamingReceiver(), intentFilter);
    }
}
```

第四步，打开app目录下的tinker-support.gradle文件，将tinkerSupport中的enable置为false。

第五步，打开AndroidManifest.xml，在Application标签下新增如下内容：

```xml
<!--可选，如果采用了热更新失败apk兜底策略，请新增该provider -->
<provider
    android:name="androidx.core.content.FileProvider"
    android:authorities="${applicationId}.provider"
    android:exported="false"
    android:grantUriPermissions="true">
    <meta-data
        android:name="android.support.FILE_PROVIDER_PATHS"
        android:resource="@xml/micro_filepaths" />
</provider>
```

以上步骤完成后，编译生成apk，运行验证即可。
