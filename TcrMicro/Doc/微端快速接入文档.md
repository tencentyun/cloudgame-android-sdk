# 快速接入版

## 整体流程描述

<img
src="https://cg-sdk-1258344699.cos.ap-nanjing.myqcloud.com/micro/docs/picture/%E5%BF%AB%E9%80%9F%E6%8E%A5%E5%85%A5%E7%89%88.png" width="600px">

快速接入版是通过静默下载游戏apk然后覆盖安装的方式来完成微端包到更新包的转化。

## 接入流程

**准备工作：**

1、将游戏包给到对接群的工作人员，工作人员会把游戏部署到腾讯云后台服务器，然后返回GameID。

2、将游戏apk上传到服务器并生成下载链接。
第一步，下载[微端包示例工程](../Demo/微端APP示例工程/TcrMicroAppForUnity2018Empty.zip)，使用AndroidStudio打开。

第二步，修改构建脚本。
打开app模块下的build.gradle文件，修改applicationId、minSdkVersion、targetSdkVersion与您的游戏工程一致，versionCode要小于游戏包的versionCode。

```groovy
defaultConfig {
        // 应用名称和您的游戏包名一致
        applicationId "com.DefaultCompany.Unity2018Empty"
        // 与你的游戏版本保持一致
        minSdkVersion 21 // 微端SDK最低支持到16
        //noinspection ExpiredTargetSdkVersion,OldTargetApi
        targetSdkVersion 29 // 与你的游戏版本保持一致
        versionCode rootProject.ext.versionCode
        versionName rootProject.ext.versionName
        ...
}
```

修改签名文件与您的游戏工程一致。

```groovy
signingConfigs {
        release {
            keyAlias "testres"
            keyPassword "testres"
            storePassword "testres"
            storeFile file("keystore/micro.keystore")
        }
    }
```

以上两步保证安装之后的apk会把微端apk替换掉。

第三步，修改工程配置。

打开工程assets下的microSettings.xml，修改对应参数

```xml
<?xml version="1.0" encoding="utf-8"?>
<settings>
    <!--    游戏ID。game-mkcru8bo(Unity2018)，game-h4c3xgp5(Unity2020)。-->
    <setting key="game_id" value="game-mkcru8bo" />
    <!--    完整apk安装下载链接，快速接入版需要填入-->
    <setting key="apk_url"
            value="https://cg-sdk-1258344699.cos.ap-nanjing.myqcloud.com/test/test.apk" />
    <!--    与云端通信的端口号-->
    <setting key="port" value="6666" />
</settings>
```

将部署之后生成的游戏ID填入到game_id中，

将apk的下载链接填入到apk_url中。

第四步，打开app目录下的micro-update-support.gradle文件，将tinkerSupport中的enable置为false。

第五步，打开AndroidManifest.xml，在Application标签下新增如下内容：

```xml
<!--微端快速接入版，请新增该provider,用于安装apk -->
<provider
    android:name="androidx.core.content.FileProvider"
    android:authorities="${applicationId}.provider"
    android:exported="false"
    android:grantUriPermissions="true">
    <meta-data
        android:name="android.support.FILE_PROVIDER_PATHS"
        android:resource="@xml/micro_filepaths" />
</provider>
```

同时在res/xml目录下，新增micro_filepaths.xml文件，文件内容如下：

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <paths>
        <external-files-path
                name="download"
                path="" />
    </paths>
</resources>
```

以上步骤完成后，编译生成apk，运行验证即可。
