## 接入步骤

请参照[SDK接入指南](../SDK接入指南.md)修改后台server地址以及MOBILE_GAME_ID

1. 在应用模块中的'build.gradle'中加入:

```xml
implementation 'com.tencent.tcr:tcrsdk-full:2.0.0-SNAPSHOT'
```

2. AndroidManifest 配置网络权限：

``` java
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.INTERNET" />
```



## 调用示例

1.初始化SDK并创建clientSession和渲染画面

``` java
TcrSdk.getInstance().init(this, null, mInitSdkCallback);
```

``` java
private final AsyncCallback<Void> mInitSdkCallback = new AsyncCallback<Void>() {
        @Override
        public void onSuccess(Void result) {
            ToastUtils.show(MobileGameActivity.this, "初始化SDK成功");
            mTcrSession = TcrSdk.getInstance().createTcrSession(createSessionConfig());
            mTcrRenderViewImpl = TcrSdk.getInstance().createTcrRenderView(MobileGameActivity.this,mTcrSession, TcrRenderViewType.SURFACE);
            mTcrSession.init(mInitSessionCallback);
        }
        @Override
        public void onFailure(int code, String msg) {
            TLog.d(TAG, "onLoadFailed code:" + code + " msg:" + msg);
        }
    };
```

2. 初始化本地clientSession后获取云端serverSession，拿到serverSession后启动云游

``` java
// 初始化会话回调，回调中会返回的clientSession需要给到后台
    private final AsyncCallback<String> mInitSessionCallback = new AsyncCallback<String>() {
        @Override
        public void onSuccess(String clientSession) {
            ToastUtils.show(MobileGameActivity.this, "初始化会话成功");
            TLog.d(TAG, "CreateSessionCallback:" + clientSession);
            // 拿客户端的clientSession去交互服务端的ServerSession
            mCloudGameApi
                    .startGame(Constant.PC_GAME_ID,clientSession, new CloudGameApi.IServerSessionListener() {
                        @Override
                        public void onSuccess(ServerResponse resp) {
                            ToastUtils.show(MobileGameActivity.this, resp.toString());
                            GameStartResponse response = (GameStartResponse) resp;
                            TLog.d(TAG, "onSuccess: " + response.toString());
                            // 请求成功，获取服务端的server session，启动游戏
                            if (response.code==0) {
                                mTcrSession.start(response.sessionDescribe.serverSession, mStartSessionCallback);
                            } else {
                                mSdkCallback.onFailure(ERROR_CODE_CALL_CLOUD_GAME_API_FAILED,response.toString());
                            }
                        }
                        @Override
                        public void onFailed(String msg) {
                            TLog.i(TAG, msg);
                            mSdkCallback.onFailure(ERROR_NETWORK_ERROR, msg);
                        }
                    });
        }
        @Override
        public void onFailure(int code, String msg) {
            TLog.d(TAG, "onFailure code:" + code + " msg:" + msg);
        }
    };
```

3.启动游戏后回调通知APP开始设置游戏画面和渲染画面，根据游戏类型设置不同的操作模式

``` java
mTcrSession.setRenderView(mTcrRenderViewImpl);
renderView.setOnTouchListener(new MobileTouchHandler());
if(mTcrRenderViewImpl.getParent() != null) {
     ((ViewGroup)mTcrRenderViewImpl.getParent()).removeView(mTcrRenderViewImpl);
}
((FrameLayout) MobileGameActivity.this.findViewById(R.id.main)).addView(mTcrRenderViewImpl);
```

## 流程

- 客户端获取的 clientSession 作为参数传递给 App 后台（传递方式业务方可以自行实现），业务后台请求云 API 锁定机器并创建会话，拿到 serverSession。
- 客户端通过 serverSession 启动游戏。其中，客户端传递 clientSession，App 后台返回 serverSession，传递方式 App 可自行实现。
- 客户端通过TcrSdk完成对SDK的初始化以及渲染画面的创建。

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h30vgu52j6j207t0in74o.jpg)

